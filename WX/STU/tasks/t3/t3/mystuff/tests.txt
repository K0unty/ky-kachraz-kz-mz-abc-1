anchor test
Error: Function _ZN4core5slice4sort6stable14driftsort_main17h13e5cf5e4726cea4E Stack offset of 4104 exceeded max offset of 4096 by 8 bytes, please minimize large stack variables. Estimated function frame size: 4160 bytes. Exceeding the maximum stack offset may cause undefined behavior during execution.

warning: use of deprecated method `anchor_lang::prelude::AccountInfo::<'a>::realloc`: Use AccountInfo::resize() instead
  --> programs/on-chain-vault/src/lib.rs:36:1
   |
36 | #[program]
   | ^^^^^^^^^^
   |
   = note: `#[warn(deprecated)]` on by default
   = note: this warning originates in the attribute macro `program` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: `on-chain-vault` (lib) generated 1 warning
    Finished `release` profile [optimized] target(s) in 0.53s
    Finished `test` profile [unoptimized + debuginfo] target(s) in 0.54s
     Running unittests src/lib.rs (/t3/t3/target/debug/deps/on_chain_vault-7c270e5ecced1fb5)

Found a 'test' script in the Anchor.toml. Running it as a test suite!

Running test suite: "/t3/t3/Anchor.toml"

yarn run v1.22.22
warning package.json: No license field
$ /t3/t3/node_modules/.bin/ts-mocha -p ./tsconfig.json -t 1000000 'tests/**/*.ts'


  on-chain-vault
    ✔ Initialize Vault Alice (unlocked) (773ms)
    ✔ Initialize Vault Bob (locked) (805ms)
    ✔ Initialize Vault Anatoly (unlocked) (818ms)
    ✔ Cannot initialize vault twice (Alice tries to initialize again)
    ✔ Cannot initialize vault for someone else (381ms)
    ✔ Deposit to Alice's vault (414ms)
    ✔ Cannot deposit to locked vault (Bob's vault)
    ✔ Cannot deposit to non-existent vault (389ms)
    1) Cannot deposit more than user balance
    ✔ Toggle lock on Bob's vault (unlock it) (360ms)
    ✔ Now can deposit to Bob's vault after unlocking (404ms)
    ✔ Toggle lock on Alice's vault (lock it) (407ms)
    ✔ Cannot deposit to Alice's vault after locking
    2) Withdraw from Bob's vault
    ✔ Cannot withdraw from Alice's locked vault
    ✔ Cannot withdraw from vault without authority
    3) Cannot withdraw more than vault balance
    ✔ Cannot toggle lock without authority
    ✔ Cannot toggle lock on non-existent vault (350ms)
    4) Unlock Alice's vault and withdraw
    ✔ Deposit to Anatoly's vault (398ms)
    5) Multiple deposits and withdrawals work correctly
    6) Cross-user deposits: Alice deposits into Bob's vault
    7) Cross-user deposits: Bob deposits into Anatoly's vault
    8) Cross-user deposits: Anatoly deposits into Alice's vault (after unlocking)
    9) Cannot cross-deposit into locked vault
    10) Only vault authority can withdraw (not depositors)


  17 passing (8s)
  10 failing

  1) on-chain-vault
       Cannot deposit more than user balance:
     TypeError: Cannot read properties of null (reading 'error')
      at /t3/t3/tests/on-chain-vault.ts:248:30
      at Generator.throw (<anonymous>)
      at rejected (tests/on-chain-vault.ts:29:65)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  2) on-chain-vault
       Withdraw from Bob's vault:
     Simulation failed. 
Message: Transaction simulation failed: Error processing Instruction 0: Cross-program invocation with unauthorized signer or writable account. 
Logs: 
[
  "Program ARmiAGe6oAEq5BKguHydD3zt2n5PkV2Q5PLA1McuMkJT invoke [1]",
  "Program log: Instruction: Withdraw",
  "GfQEacgtefu8REDbnFpNh5akJoXTdRDnTSn7Ft9LTpGi's signer privilege escalated",
  "Program ARmiAGe6oAEq5BKguHydD3zt2n5PkV2Q5PLA1McuMkJT consumed 4739 of 200000 compute units",
  "Program ARmiAGe6oAEq5BKguHydD3zt2n5PkV2Q5PLA1McuMkJT failed: Cross-program invocation with unauthorized signer or writable account"
]. 
Catch the `SendTransactionError` and call `getLogs()` on it for full details.
  

  3) on-chain-vault
       Cannot withdraw more than vault balance:

      Should fail with InsufficientBalance error
      + expected - actual

      -InsufficientFunds
      +InsufficientBalance
      
      at /t3/t3/tests/on-chain-vault.ts:415:14
      at Generator.throw (<anonymous>)
      at rejected (tests/on-chain-vault.ts:29:65)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  4) on-chain-vault
       Unlock Alice's vault and withdraw:
     Simulation failed. 
Message: Transaction simulation failed: Error processing Instruction 0: Cross-program invocation with unauthorized signer or writable account. 
Logs: 
[
  "Program ARmiAGe6oAEq5BKguHydD3zt2n5PkV2Q5PLA1McuMkJT invoke [1]",
  "Program log: Instruction: Withdraw",
  "CGHA67kHzLT8GzxYtX4qwvCsr5gtu3WaD5MFw5TgR8nh's signer privilege escalated",
  "Program ARmiAGe6oAEq5BKguHydD3zt2n5PkV2Q5PLA1McuMkJT consumed 4739 of 200000 compute units",
  "Program ARmiAGe6oAEq5BKguHydD3zt2n5PkV2Q5PLA1McuMkJT failed: Cross-program invocation with unauthorized signer or writable account"
]. 
Catch the `SendTransactionError` and call `getLogs()` on it for full details.
  

  5) on-chain-vault
       Multiple deposits and withdrawals work correctly:
     Simulation failed. 
Message: Transaction simulation failed: Error processing Instruction 0: Cross-program invocation with unauthorized signer or writable account. 
Logs: 
[
  "Program ARmiAGe6oAEq5BKguHydD3zt2n5PkV2Q5PLA1McuMkJT invoke [1]",
  "Program log: Instruction: Withdraw",
  "9bZ2AfyTkuSYQgUZKPk9ke4rHg55wbDGSzXRKUQf8xbJ's signer privilege escalated",
  "Program ARmiAGe6oAEq5BKguHydD3zt2n5PkV2Q5PLA1McuMkJT consumed 7739 of 200000 compute units",
  "Program ARmiAGe6oAEq5BKguHydD3zt2n5PkV2Q5PLA1McuMkJT failed: Cross-program invocation with unauthorized signer or writable account"
]. 
Catch the `SendTransactionError` and call `getLogs()` on it for full details.
  

  6) on-chain-vault
       Cross-user deposits: Alice deposits into Bob's vault:
     Error: AnchorError caused by account: vault. Error Code: ConstraintSeeds. Error Number: 2006. Error Message: A seeds constraint was violated.
Program log: Left:
Program log: GfQEacgtefu8REDbnFpNh5akJoXTdRDnTSn7Ft9LTpGi
Program log: Right:
Program log: CGHA67kHzLT8GzxYtX4qwvCsr5gtu3WaD5MFw5TgR8nh
      at Function.parse (node_modules/@coral-xyz/anchor/src/error.ts:168:14)
      at translateError (node_modules/@coral-xyz/anchor/src/error.ts:277:35)
      at MethodsBuilder.rpc [as _rpcFn] (node_modules/@coral-xyz/anchor/src/program/namespace/rpc.ts:35:29)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  7) on-chain-vault
       Cross-user deposits: Bob deposits into Anatoly's vault:
     Error: AnchorError caused by account: vault. Error Code: ConstraintSeeds. Error Number: 2006. Error Message: A seeds constraint was violated.
Program log: Left:
Program log: 9bZ2AfyTkuSYQgUZKPk9ke4rHg55wbDGSzXRKUQf8xbJ
Program log: Right:
Program log: GfQEacgtefu8REDbnFpNh5akJoXTdRDnTSn7Ft9LTpGi
      at Function.parse (node_modules/@coral-xyz/anchor/src/error.ts:168:14)
      at translateError (node_modules/@coral-xyz/anchor/src/error.ts:277:35)
      at MethodsBuilder.rpc [as _rpcFn] (node_modules/@coral-xyz/anchor/src/program/namespace/rpc.ts:35:29)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  8) on-chain-vault
       Cross-user deposits: Anatoly deposits into Alice's vault (after unlocking):
     Error: AnchorError caused by account: vault. Error Code: ConstraintSeeds. Error Number: 2006. Error Message: A seeds constraint was violated.
Program log: Left:
Program log: CGHA67kHzLT8GzxYtX4qwvCsr5gtu3WaD5MFw5TgR8nh
Program log: Right:
Program log: 9bZ2AfyTkuSYQgUZKPk9ke4rHg55wbDGSzXRKUQf8xbJ
      at Function.parse (node_modules/@coral-xyz/anchor/src/error.ts:168:14)
      at translateError (node_modules/@coral-xyz/anchor/src/error.ts:277:35)
      at MethodsBuilder.rpc [as _rpcFn] (node_modules/@coral-xyz/anchor/src/program/namespace/rpc.ts:35:29)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  9) on-chain-vault
       Cannot cross-deposit into locked vault:

      Should fail with VaultLocked error
      + expected - actual

      -ConstraintSeeds
      +VaultLocked
      
      at /t3/t3/tests/on-chain-vault.ts:634:14
      at Generator.throw (<anonymous>)
      at rejected (tests/on-chain-vault.ts:29:65)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  10) on-chain-vault
       Only vault authority can withdraw (not depositors):
     Error: AnchorError caused by account: vault. Error Code: ConstraintSeeds. Error Number: 2006. Error Message: A seeds constraint was violated.
Program log: Left:
Program log: CGHA67kHzLT8GzxYtX4qwvCsr5gtu3WaD5MFw5TgR8nh
Program log: Right:
Program log: GfQEacgtefu8REDbnFpNh5akJoXTdRDnTSn7Ft9LTpGi
      at Function.parse (node_modules/@coral-xyz/anchor/src/error.ts:168:14)
      at translateError (node_modules/@coral-xyz/anchor/src/error.ts:277:35)
      at MethodsBuilder.rpc [as _rpcFn] (node_modules/@coral-xyz/anchor/src/program/namespace/rpc.ts:35:29)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)



error Command failed with exit code 10.